<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload your Section 14 SSM doc</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Quicksand', sans-serif;
            line-height: 1.6;
            color: #002940;
            background: linear-gradient(135deg, #fcf7f3 0%, #ecfffb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 20px auto;
            background: #FFFFFF;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 41, 64, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #27d8b2 0%, #8ce4d1 100%);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            width: 120px;
            height: auto;
            margin-bottom: 20px;
            filter: drop-shadow(0 2px 8px rgba(39, 216, 178, 0.2));
        }
        
        .logo-placeholder {
            width: 120px;
            height: 40px;
            background: linear-gradient(135deg, #27d8b2 0%, #8ce4d1 100%);
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #FFFFFF;
            font-size: 16px;
            letter-spacing: 1px;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 41, 64, 0.2);
        }
        
        h1 {
            color: #002940;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .info-box {
            background: linear-gradient(135deg, #ecfffb 0%, #b4e9de 20%);
            border-left: 4px solid #27d8b2;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .info-box strong {
            color: #002940;
            font-weight: 600;
        }
        
        .info-box small {
            color: #305063;
            font-size: 14px;
        }
        
        .greeting {
            font-size: 18px;
            color: #002940;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .description {
            color: #305063;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .upload-area {
            border: 2px dashed #8ce4d1;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #FFFFFF;
        }
        
        .upload-area:hover {
            border-color: #27d8b2;
            background-color: #fcf7f3;
        }
        
        .upload-area.dragover {
            border-color: #27d8b2;
            background-color: #ecfffb;
        }
        
        .upload-area h3 {
            color: #002940;
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .upload-area p {
            color: #305063;
            margin: 15px 0;
            font-size: 16px;
        }
        
        .upload-area small {
            color: #778c98;
            font-size: 13px;
            margin-top: 15px;
            display: block;
        }
        
        .choose-file-btn {
            background: #27d8b2;
            color: #FFFFFF;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Quicksand', sans-serif;
            transition: all 0.3s ease;
        }
        
        .choose-file-btn:hover {
            background: #1fc4a0;
        }
        
        .btn {
            background: linear-gradient(135deg, #27d8b2 0%, #8ce4d1 100%);
            color: #FFFFFF;
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Quicksand', sans-serif;
            margin: 10px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 216, 178, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 216, 178, 0.4);
        }
        
        .btn:disabled {
            background: linear-gradient(135deg, #778c98 0%, #b4b4b4 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .message {
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 8px;
            display: none;
            font-weight: 500;
        }
        
        .success {
            background: linear-gradient(135deg, #ecfffb 0%, #b4e9de 100%);
            color: #002940;
            border: 1px solid #27d8b2;
            border-left: 4px solid #27d8b2;
        }
        
        .error {
            background: linear-gradient(135deg, #ffe8e8 0%, #ffcccb 100%);
            color: #8b0000;
            border: 1px solid #ff6b6b;
            border-left: 4px solid #ff6b6b;
        }
        
        .processing {
            background: linear-gradient(135deg, #f9efb6 0%, #fff3cd 100%);
            color: #305063;
            border: 1px solid #f9efb6;
            border-left: 4px solid #27d8b2;
        }
        
        .file-info {
            background: linear-gradient(135deg, #ecfffb 0%, rgba(180, 233, 222, 0.3) 100%);
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #27d8b2;
            display: none;
            color: #002940;
        }
        
        .extraction-preview {
            background: linear-gradient(135deg, #ecfffb 0%, #b4e9de 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #27d8b2;
            display: none;
        }
        
        .extraction-preview h4 {
            color: #002940;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .company-info-box {
            margin: 15px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border-left: 4px solid #27d8b2;
            color: #002940;
        }
        
        .company-info-box h5 {
            color: #002940;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .company-detail {
            margin: 8px 0;
            color: #002940;
            line-height: 1.4;
        }
        
        .company-detail strong {
            color: #002940;
            font-weight: 600;
            min-width: 140px;
            display: inline-block;
        }
        
        .directors-section {
            margin: 20px 0;
        }
        
        .directors-section h5 {
            color: #002940;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .director-box {
            margin: 12px 0;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border-left: 4px solid #27d8b2;
            color: #002940;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .director-box:hover {
            background: rgba(39, 216, 178, 0.05);
            transform: translateY(-1px);
        }
        
        .director-box.selected {
            background: rgba(39, 216, 178, 0.1);
            border-left-color: #1fc4a0;
        }
        
        .director-radio {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .director-info {
            margin-right: 40px;
        }
        
        .director-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: #002940;
        }
        
        .director-details {
            font-size: 14px;
            color: #305063;
            line-height: 1.4;
        }
        
        .approval-section {
            margin: 30px 0 20px 0;
            text-align: center;
        }
        
        .request-approval-btn {
            background: linear-gradient(135deg, #27d8b2 0%, #8ce4d1 100%);
            color: #FFFFFF;
            padding: 16px 32px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Quicksand', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 216, 178, 0.3);
            min-width: 200px;
        }
        
        .request-approval-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 216, 178, 0.4);
        }
        
        .request-approval-btn:disabled {
            background: linear-gradient(135deg, #778c98 0%, #b4b4b4 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .send-comment-btn {
            background: linear-gradient(135deg, #ffa726 0%, #ffcc80 100%);
            color: #FFFFFF;
            padding: 16px 32px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Quicksand', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 167, 38, 0.3);
            min-width: 200px;
            margin-left: 15px;
        }
        
        .send-comment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 167, 38, 0.4);
        }
        
        .send-comment-btn:disabled {
            background: linear-gradient(135deg, #778c98 0%, #b4b4b4 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .comment-section {
            margin: 30px 0 20px 0;
            text-align: center;
            border-top: 2px solid #e0e0e0;
            padding-top: 30px;
        }
        
        .comment-copy {
            font-size: 16px;
            color: #555;
            margin-bottom: 20px;
            font-family: 'Quicksand', sans-serif;
        }
        
        .comment-input {
            width: 80%;
            max-width: 500px;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            font-family: 'Quicksand', sans-serif;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .comment-input:focus {
            border-color: #ffa726;
            box-shadow: 0 0 10px rgba(255, 167, 38, 0.2);
        }
        
        .email-input-section {
            margin: 10px 0;
            padding: 10px;
            background: rgba(39, 216, 178, 0.1);
            border-radius: 8px;
            border: 1px dashed #27d8b2;
        }
        
        .email-input {
            width: 100%;
            max-width: 300px;
            padding: 8px 12px;
            border: 2px solid #27d8b2;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Quicksand', sans-serif;
            margin-bottom: 10px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .email-input:focus {
            border-color: #1fc4a0;
            box-shadow: 0 0 8px rgba(39, 216, 178, 0.2);
        }
        
        .save-email-btn {
            background: linear-gradient(135deg, #27d8b2 0%, #8ce4d1 100%);
            color: #FFFFFF;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            font-family: 'Quicksand', sans-serif;
            transition: all 0.3s ease;
            margin-left: 5px;
        }
        
        .save-email-btn:hover {
            background: linear-gradient(135deg, #1fc4a0 0%, #7dd9c6 100%);
            transform: translateY(-1px);
        }
        
        .save-email-btn:disabled {
            background: linear-gradient(135deg, #778c98 0%, #b4b4b4 100%);
            cursor: not-allowed;
            transform: none;
        }
        
        /* Mobile Responsive */
        @media (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 25px 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .upload-area {
                padding: 30px 20px;
            }
            
            .btn {
                width: 100%;
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img class="logoImg" src="http://cdn.mcauto-images-production.sendgrid.net/a45ca1152023e5ca/96a74b65-4c90-4b68-a001-5ea2890483c4/134x48.png" alt="Swipey Logo" width="133" height="48" style="margin:0 auto 20px auto; border:0; padding:0; max-width:133px; display:block; height:auto; filter: drop-shadow(0 2px 8px rgba(39, 216, 178, 0.2));">
            <h1>Upload your Section 14 SSM doc</h1>
        </div>
        
        <div class="info-box">
            <strong>Wait on page after uploading for next steps</strong>
        </div>
        
        <div class="greeting">Hello <strong>{{ customer_name }}</strong>! üëã</div>
        <div class="description">
            Let's verify your company. We need your SSM document section 14.
        </div>
        
        <div class="upload-area" id="uploadArea">
            <div>
                <h3>Drop your PDF file here</h3>
                <p>or</p>
                <button type="button" class="choose-file-btn" onclick="document.getElementById('fileInput').click()">
                    Choose File
                </button>
                <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                <small>Maximum file size: 10MB | PDF files only</small>
            </div>
        </div>

        <div class="file-info" id="fileInfo"></div>

        <button type="button" class="btn" id="uploadBtn" onclick="uploadFile()" disabled>
            üöÄ Launch Docs
        </button>

        <div class="message" id="message"></div>
        <div class="extraction-preview" id="extractionPreview"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInfo = document.getElementById('fileInfo');
        const message = document.getElementById('message');
        const extractionPreview = document.getElementById('extractionPreview');

        let selectedFile = null;
        const customerToken = '{{ token }}';

        // File handlers
        fileInput.addEventListener('change', handleFileSelect);

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            handleFile(e.target.files[0]);
        }

        function handleFile(file) {
            if (!file) return;

            if (file.type !== 'application/pdf') {
                showMessage('Please select a PDF file only.', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showMessage('File size must be less than 10MB.', 'error');
                return;
            }

            selectedFile = file;
            fileInfo.innerHTML = `
                <strong>‚úÖ File ready:</strong> ${file.name}<br>
                <strong>üìä Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB
            `;
            fileInfo.style.display = 'block';
            uploadBtn.disabled = false;
            message.style.display = 'none';
            extractionPreview.style.display = 'none';
        }

        async function uploadFile() {
            if (!selectedFile || !customerToken) {
                showMessage('No file selected or invalid upload link.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('document', selectedFile);

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'üîÑ Processing...';
            showMessage('üöÄ Processing your document. Please wait on this page for next steps...', 'processing');
            
            try {
                // Use the ASYNC endpoint
                const response = await fetch(`/upload-file-async/${customerToken}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('‚úÖ Document processed successfully! Data Extracted!.', 'success');
                    
                    // Show extraction preview
                    if (result.extracted_preview) {
                        showExtractionPreview(result.extracted_preview);
                    }
                    
                    // Reset form
                    selectedFile = null;
                    fileInput.value = '';
                    fileInfo.style.display = 'none';
                    uploadBtn.disabled = true;
                    uploadBtn.textContent = 'üöÄ Upload Docs';
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                showMessage(`‚ùå Upload failed: ${error.message}`, 'error');
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ Launch Docs';
            }
        }

        function showMessage(text, type) {
            message.innerHTML = text;
            message.className = `message ${type}`;
            message.style.display = 'block';
        }

        function showExtractionPreview(data) {
            let html = '<h4>üìã Extracted Information:</h4>';
            
            // Company Information Box
            html += '<div class="company-info-box">';
            html += '<h5>üè¢ Company Information</h5>';
            
            if (data.company_name) {
                html += `<div class="company-detail"><strong>Company:</strong> ${data.company_name}</div>`;
            }
            if (data.registration_number) {
                html += `<div class="company-detail"><strong>Registration:</strong> ${data.registration_number}</div>`;
            }
            if (data.incorporation_date) {
                html += `<div class="company-detail"><strong>Incorporation Date:</strong> ${data.incorporation_date}</div>`;
            }
            if (data.company_type) {
                html += `<div class="company-detail"><strong>Type:</strong> ${data.company_type}</div>`;
            }
            if (data.business_address) {
                html += `<div class="company-detail"><strong>Address:</strong> ${data.business_address}</div>`;
            }
            if (data.business_phone) {
                html += `<div class="company-detail"><strong>Phone:</strong> ${data.business_phone}</div>`;
            }
            
            html += '</div>';
            
            // Directors Section
            if (data.directors && data.directors.length > 0) {
                html += '<div class="directors-section">';
                
                // Dynamic header based on number of directors
                if (data.directors.length > 1) {
                    html += '<h5>üë• Directors: Need approval to activate Swipey account from a director. Select a director that will receive e-signature request</h5>';
                } else {
                    html += '<h5>üë• Director: Need approval to activate account. Click "Request Approval" from listed director</h5>';
                }
                
                data.directors.forEach((director, index) => {
                    const directorId = `director_${index}`;
                    html += `<div class="director-box" onclick="selectDirector('${directorId}')">`;
                    
                    // Always show radio button for consistency
                    html += `<input type="radio" name="selectedDirector" class="director-radio" id="${directorId}" value="${index}">`;
                    
                    html += '<div class="director-info">';
                    html += `<div class="director-name">${director.name || 'Unknown Director'}</div>`;
                    html += '<div class="director-details">';
                    
                    if (director.id_number) {
                        html += `ID: ${director.id_number}<br>`;
                    }
                    if (director.email) {
                        html += `Email: ${director.email}<br>`;
                    } else {
                        html += `<div class="email-input-section">`;
                        html += `<input type="email" class="email-input" id="email_${index}" placeholder="Enter director email" required>`;
                        html += `<button type="button" class="save-email-btn" onclick="saveDirectorEmail(${index})">Save Email</button>`;
                        html += `</div>`;
                    }
                    if (director.nationality) {
                        html += `Nationality: ${director.nationality}<br>`;
                    }
                    if (director.shares) {
                        html += `Shares: ${director.shares}`;
                    }
                    
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            // Approval Section
            html += '<div class="approval-section">';
            html += '<button type="button" class="request-approval-btn" onclick="requestApproval()">üìù Request Approval</button>';
            html += '</div>';
            
            // Comment Section
            html += '<div class="comment-section">';
            html += '<div class="comment-copy">Information incorrect and need help from our rockstar team, click below</div>';
            html += '<input type="text" class="comment-input" id="commentInput" placeholder="Enter your comment or question here..." maxlength="500">';
            html += '<br>';
            html += '<button type="button" class="send-comment-btn" onclick="sendComment()">üí¨ Send Comment</button>';
            html += '</div>';
            
            extractionPreview.innerHTML = html;
            extractionPreview.style.display = 'block';
            
            // Auto-select first director by default (for both single and multiple directors)
            if (data.directors && data.directors.length > 0) {
                setTimeout(() => {
                    selectDirector('director_0');
                }, 100); // Small delay to ensure DOM is ready
            }
        }
        
        function selectDirector(directorId) {
            // Remove selected class from all director boxes
            document.querySelectorAll('.director-box').forEach(box => {
                box.classList.remove('selected');
            });
            
            // Add selected class to clicked box
            const directorBox = document.querySelector(`#${directorId}`);
            if (directorBox) {
                const parentBox = directorBox.closest('.director-box');
                if (parentBox) {
                    parentBox.classList.add('selected');
                }
                // Check the radio button
                directorBox.checked = true;
            } else {
                // For single director case (no radio button), just highlight the box
                const singleDirectorBox = document.querySelector('.director-box');
                if (singleDirectorBox) {
                    singleDirectorBox.classList.add('selected');
                }
            }
        }
        
        function saveDirectorEmail(directorIndex) {
            const emailInput = document.getElementById(`email_${directorIndex}`);
            const email = emailInput.value.trim();
            const saveBtn = emailInput.nextElementSibling;
            
            if (!email) {
                alert('Please enter a valid email address.');
                emailInput.focus();
                return;
            }
            
            // Basic email validation
            if (!email.includes('@') || !email.includes('.')) {
                alert('Please enter a valid email format.');
                emailInput.focus();
                return;
            }
            
            // Show loading state
            const originalBtnText = saveBtn.textContent;
            saveBtn.textContent = '‚è≥ Saving...';
            saveBtn.disabled = true;
            
            // Send email update to backend
            fetch(`/update-director-email/${customerToken}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    directorIndex: directorIndex,
                    email: email
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Replace email input with saved email display
                    const emailSection = emailInput.parentElement;
                    emailSection.innerHTML = `Email: ${email}<br>`;
                    emailSection.classList.remove('email-input-section');
                    emailSection.style.background = 'none';
                    emailSection.style.border = 'none';
                    emailSection.style.padding = '0';
                    
                    alert(`‚úÖ Email saved for ${data.director_name || 'director'}`);
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                    // Reset button on error
                    saveBtn.textContent = originalBtnText;
                    saveBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Failed to save email. Please try again.');
                // Reset button on error
                saveBtn.textContent = originalBtnText;
                saveBtn.disabled = false;
            });
        }
        
        function requestApproval() {
            console.log('requestApproval() called');
            
            // Check if any directors are missing emails
            const emailInputs = document.querySelectorAll('.email-input');
            if (emailInputs.length > 0) {
                alert('Please provide email addresses for all directors before requesting approval.');
                return;
            }
            
            // Get selected director (if multiple)
            const selectedDirector = document.querySelector('input[name="selectedDirector"]:checked');
            const directorIndex = selectedDirector ? selectedDirector.value : 0;
            
            console.log('Selected director index:', directorIndex);
            
            // Get selected director info for confirmation
            const directorBoxes = document.querySelectorAll('.director-box');
            const selectedBox = document.querySelector('.director-box.selected');
            
            console.log('Director boxes found:', directorBoxes.length);
            console.log('Selected box:', selectedBox);
            
            if (!selectedBox && directorBoxes.length > 1) {
                alert('Please select a director first.');
                return;
            }
            
            // Get director name for confirmation
            const directorNameElement = selectedBox ? selectedBox.querySelector('.director-name') : null;
            const directorName = directorNameElement ? directorNameElement.textContent : `Director ${parseInt(directorIndex) + 1}`;
            
            console.log('Director name:', directorName);
            
            // Confirmation dialog
            if (confirm(`Send e-signature request to ${directorName}?\n\nThis will trigger the account activation process.`)) {
                console.log('User confirmed, proceeding with request');
                // Show loading state
                const button = document.querySelector('.request-approval-btn');
                const originalText = button.textContent;
                
                // Prevent multiple clicks
                if (button.disabled) {
                    console.log('Button already disabled, ignoring click');
                    return;
                }
                
                button.textContent = '‚è≥ Sending...';
                button.disabled = true;
                
                // Send request to our eSignature_Request route with selected director index
                console.log('Making fetch request to:', `/eSignature_Request/{{ token }}`);
                console.log('Request body:', {selectedDirector: directorIndex});
                
                fetch(`/eSignature_Request/{{ token }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        selectedDirector: directorIndex
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ ${data.message}`);
                        // Optionally disable the button after successful request
                        button.textContent = '‚úÖ Request Sent';
                        button.style.backgroundColor = '#28a745';
                    } else {
                        alert(`‚ùå Error: ${data.error}`);
                        // Reset button on error
                        button.textContent = originalText;
                        button.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Failed to send e-signature request. Please try again.');
                    // Reset button on error
                    button.textContent = originalText;
                    button.disabled = false;
                });
            }
        }
        
        function sendComment() {
            const commentInput = document.getElementById('commentInput');
            const comment = commentInput.value.trim();
            
            if (!comment) {
                alert('Please enter a comment before sending.');
                commentInput.focus();
                return;
            }
            
            // Show loading state
            const button = document.querySelector('.send-comment-btn');
            const originalText = button.textContent;
            button.textContent = '‚è≥ Sending...';
            button.disabled = true;
            
            // Send comment to backend
            fetch(`/sendComment/{{ token }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comment: comment
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Comment sent successfully! Our team will review and get back to you.');
                    commentInput.value = ''; // Clear the input
                    button.textContent = '‚úÖ Comment Sent';
                    button.style.backgroundColor = '#28a745';
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                    // Reset button on error
                    button.textContent = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Failed to send comment. Please try again.');
                // Reset button on error
                button.textContent = originalText;
                button.disabled = false;
            });
        }
    </script>
</body>
</html>